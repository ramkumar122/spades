<div class="page dark">
  <!-- Setup -->
  <section *ngIf="!game()" class="setup-panel">
    <div class="setup-header">
      <div>
        <p class="eyebrow">Spades Scoreboard</p>
        <h1>Build your table</h1>
        <p class="muted">13 rounds ‚Ä¢ Exact match = +bid ‚Ä¢ Overbid = ‚àíwon ‚Ä¢ Underbid = ‚àíbid</p>
      </div>
      <div class="actions">
        <button class="primary" type="button" (click)="startGame()">Start</button>
      </div>
    </div>

    <div class="mode-row">
      <label class="toggle">
        <input type="radio" name="mode" [checked]="!playingTeams()" (change)="playingTeams.set(false)" />
        <span>Solo (no teams)</span>
      </label>
      <label class="toggle">
        <input type="radio" name="mode" [checked]="playingTeams()" (change)="playingTeams.set(true)" />
        <span>Teams</span>
      </label>
    </div>

    <ng-container *ngIf="playingTeams(); else soloMode">
      <div class="setup-grid">
        <div class="team-setup" *ngFor="let team of setupTeams(); let t = index; trackBy: trackByIndex">
          <p class="team-label">Team {{ t + 1 }}</p>
          <div class="input-list">
            <div class="input-row" *ngFor="let name of team; let i = index; trackBy: trackByIndex">
              <input
                type="text"
                [ngModel]="name"
                (ngModelChange)="updateSetupPlayer(t, i, $event)"
                placeholder="Player name"
              />
              <button class="ghost danger" type="button" (click)="removeSetupPlayer(t, i)">‚úï</button>
            </div>
          </div>
          <button class="ghost" type="button" (click)="addSetupPlayer(t)">Add player</button>
        </div>
      </div>
      <div class="add-team-row">
        <button class="ghost" type="button" (click)="addTeam()">+ Add team</button>
      </div>
    </ng-container>

    <ng-template #soloMode>
      <div class="team-setup solo">
        <p class="team-label">Players</p>
        <div class="input-list">
          <div class="input-row" *ngFor="let name of setupSolo(); let i = index; trackBy: trackByIndex">
            <input
              type="text"
              [ngModel]="name"
              (ngModelChange)="updateSoloPlayer(i, $event)"
              placeholder="Player name"
            />
            <button class="ghost danger" type="button" (click)="removeSoloPlayer(i)">‚úï</button>
          </div>
        </div>
        <button class="ghost" type="button" (click)="addSoloPlayer()">Add player</button>
      </div>
    </ng-template>

    <div class="options-row">
      <label class="toggle">
        <input type="checkbox" [ngModel]="enforceTotal()" (ngModelChange)="enforceTotal.set(!!$event)" />
        <span>Require total wins per round to equal 13 tricks</span>
        <small class="muted">(turn on only if you track all 13 tricks each round)</small>
      </label>
      <div class="muted counts">{{ totalPlayersCount() }} / 12 players</div>
    </div>

    <p class="validation" *ngIf="validationMessage()">{{ validationMessage() }}</p>
  </section>

  <!-- Game -->
  <section *ngIf="game() as g" class="board">
    <header class="score-hero">
      <div class="nav">
        <button class="pill" type="button" (click)="goToRound(-1)" [disabled]="currentRoundIndex() === 0">‚Üê</button>
        <div class="round-tag">Round {{ currentRoundIndex() + 1 }} / 13</div>
        <button class="pill" type="button" (click)="goToRound(1)" [disabled]="currentRoundIndex() === 12">‚Üí</button>
      </div>

      <div class="score-strip" *ngIf="playingTeams(); else soloScore">
        <div class="team-block" *ngIf="teamLeaderboard()[0] as t1">
          <p class="label">{{ t1.name }}</p>
          <div class="score-big">{{ t1.total }}</div>
          <div class="sub">This round: {{ teamRoundScore(t1.id, currentRoundIndex()) }}</div>
        </div>
        <div class="center-block">
          <p class="eyebrow">Score</p>
          <h2>{{ g.name || 'Untitled table' }}</h2>
          <p class="muted">Unclaimed: {{ unclaimedTricks(currentRoundIndex()) }}</p>
          <p class="muted">Players: {{ g.players.length }}</p>
        </div>
        <div class="team-block" *ngIf="teamLeaderboard()[1] as t2">
          <p class="label">{{ t2.name }}</p>
          <div class="score-big alt">{{ t2.total }}</div>
          <div class="sub">This round: {{ teamRoundScore(t2.id, currentRoundIndex()) }}</div>
        </div>
      </div>
      <ng-template #soloScore>
        <div class="score-strip solo">
          <div class="team-block">
            <p class="label">Total</p>
            <div class="score-big">{{ teamTotalScore(0) }}</div>
            <div class="sub">This round: {{ teamRoundScore(0, currentRoundIndex()) }}</div>
            <div class="sub">Unclaimed: {{ unclaimedTricks(currentRoundIndex()) }}</div>
            <div class="sub">Players: {{ g.players.length }}</div>
          </div>
        </div>
      </ng-template>

      <div class="actions">
        <button class="ghost" type="button" (click)="copySummary()">Copy</button>
        <button class="ghost" type="button" (click)="downloadCsv()">CSV</button>
        <button class="ghost" type="button" (click)="downloadJson()">JSON</button>
        <button class="primary" type="button" (click)="resetGame()">New Game</button>
      </div>
    </header>

    <div class="round-card">
      <div class="round-head">
        <div class="label">Bids &amp; Actuals</div>
        <div class="muted">Exact match = +bid ‚Ä¢ Overbid = ‚àíwon ‚Ä¢ Underbid = ‚àíbid</div>
        <div class="round-nav-mini">
          <button class="pill" type="button" (click)="goToRound(-1)" [disabled]="currentRoundIndex() === 0">‚Üê</button>
          <div class="round-chip">Round {{ currentRoundIndex() + 1 }} / 13</div>
          <button class="pill" type="button" (click)="goToRound(1)" [disabled]="currentRoundIndex() === 12">‚Üí</button>
        </div>
        <div class="round-chip info">Total bids: {{ roundBidsTotal(currentRoundIndex()) }}</div>
      </div>

      <div class="teams-row" *ngIf="playingTeams(); else soloEntries">
        <div class="team-col" *ngFor="let teamId of teamIds(); trackBy: trackByIndex">
          <div class="team-title">
            <span>{{ teamLabel(teamId) }}</span>
            <span class="round-total">{{ teamRoundScore(teamId, currentRoundIndex()) }}</span>
          </div>
          <div class="entries">
            <div class="entry" *ngFor="let player of teamPlayers(teamId); trackBy: trackById">
              <div class="name">{{ player.name }}</div>
              <div class="inputs">
                <label>Bid</label>
                <input
                  #bidInput
                  type="number"
                  inputmode="numeric"
                  min="0"
                  max="13"
                  [ngModel]="g.rounds[currentRoundIndex()].bids[player.id]"
                  (ngModelChange)="setBid(player.id, $event)"
                />
                <label>Won</label>
                <input
                  type="number"
                  inputmode="numeric"
                  min="0"
                  max="13"
                  [ngModel]="g.rounds[currentRoundIndex()].wins[player.id]"
                  (ngModelChange)="setWin(player.id, $event)"
                />
              </div>
              <div class="entry-score" [class.match]="roundScore(player.id, currentRoundIndex()) === g.rounds[currentRoundIndex()].bids[player.id] && roundScore(player.id, currentRoundIndex()) !== null" [class.penalty]="roundScore(player.id, currentRoundIndex()) !== null && roundScore(player.id, currentRoundIndex()) !== g.rounds[currentRoundIndex()].bids[player.id]">
                {{ roundScore(player.id, currentRoundIndex()) ?? '‚Äî' }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <ng-template #soloEntries>
        <div class="team-col solo">
          <div class="team-title">
            <span>Players</span>
            <span class="round-total">{{ teamRoundScore(0, currentRoundIndex()) }}</span>
          </div>
          <div class="entries">
            <div class="entry" *ngFor="let player of g.players; trackBy: trackById">
              <div class="name">{{ player.name }}</div>
              <div class="inputs">
                <label>Bid</label>
                <input
                  #bidInput
                  type="number"
                  inputmode="numeric"
                  min="0"
                  max="13"
                  [ngModel]="g.rounds[currentRoundIndex()].bids[player.id]"
                  (ngModelChange)="setBid(player.id, $event)"
                />
                <label>Won</label>
                <input
                  type="number"
                  inputmode="numeric"
                  min="0"
                  max="13"
                  [ngModel]="g.rounds[currentRoundIndex()].wins[player.id]"
                  (ngModelChange)="setWin(player.id, $event)"
                />
              </div>
              <div class="entry-score" [class.match]="roundScore(player.id, currentRoundIndex()) === g.rounds[currentRoundIndex()].bids[player.id] && roundScore(player.id, currentRoundIndex()) !== null" [class.penalty]="roundScore(player.id, currentRoundIndex()) !== null && roundScore(player.id, currentRoundIndex()) !== g.rounds[currentRoundIndex()].bids[player.id]">
                {{ roundScore(player.id, currentRoundIndex()) ?? '‚Äî' }}
              </div>
            </div>
          </div>
        </div>
      </ng-template>

      <div class="round-meta">
        <div class="chip">Unclaimed tricks: {{ unclaimedTricks(currentRoundIndex()) }}</div>
        <div class="chip">Bids filled: {{ roundHasAllBids() ? 'Yes' : 'No' }}</div>
        <div class="chip">Wins filled: {{ roundHasAllWins() ? 'Yes' : 'No' }}</div>
        <div class="chip">Completed: {{ completedRounds() }} / 13</div>
        <div class="chip warning" *ngIf="!roundSumOk(currentRoundIndex())">
          Total Won must equal {{ currentRoundIndex() + 1 }} for this round
        </div>
      </div>

      <div class="standings">
        <div class="standings-head">
          <div>
            <p class="label">{{ playingTeams() ? 'Team standings' : 'Player standings' }}</p>
            <h3>Totals (high to low)</h3>
          </div>
          <div class="standings-controls">
            <label class="toggle small">
              <input type="checkbox" [ngModel]="showRanks()" (ngModelChange)="showRanks.set(!!$event)" />
              <span>Show ranks</span>
            </label>
            <span class="muted">Updated live</span>
          </div>
        </div>
        <ng-container *ngIf="playingTeams(); else playerStandings">
          <div class="standings-list">
            <div class="stand-row" *ngFor="let row of teamLeaderboard(); let i = index">
              <span class="rank" *ngIf="showRanks()">{{ emojiForRank(i) }} #{{ i + 1 }}</span>
              <span class="name">{{ row.name }}</span>
              <span class="meta muted">Team total</span>
              <span class="total">{{ row.total }}</span>
            </div>
          </div>
        </ng-container>
        <ng-template #playerStandings>
          <div class="standings-list">
            <div class="stand-row" *ngFor="let row of leaderboard(); let i = index">
              <span class="rank" *ngIf="showRanks()">{{ emojiForRank(i) }} #{{ i + 1 }}</span>
              <span class="name">{{ row.player.name }}</span>
              <span class="meta muted">Matches {{ row.matches }} ‚Ä¢ Avg bid {{ row.avgBid | number:'1.1-1' }} ‚Ä¢ Avg won {{ row.avgWon | number:'1.1-1' }}</span>
              <span class="total">{{ row.total }}</span>
            </div>
          </div>
        </ng-template>
      </div>

      <div class="final-card" *ngIf="isGameComplete()">
        <div class="final-header">
          <h3>Game finished</h3>
          <p class="muted">Trophies are in! Here‚Äôs where everyone stands.</p>
        </div>
        <div class="celebrate">
          <div class="confetti">‚ú® üéâ üèÜ üéâ ‚ú®</div>
          <div class="podium-grid">
            <div class="podium-block second" *ngIf="podiumDisplay().top3[1] as p2">
              <div class="trophy">ü•à</div>
              <div class="rank-num">2</div>
              <div class="podium-name">{{ p2.label }}</div>
              <div class="muted small">Total {{ p2.total }}</div>
            </div>
            <div class="podium-block first" *ngIf="podiumDisplay().top3[0] as p1">
              <div class="trophy">ü•á</div>
              <div class="rank-num">1</div>
              <!--  <div class="podium-name">{{ p1.label }}</div> -->
              <div class="podium-name victory">‡∞µ‡±Ä‡∞∞‡∞æ‡∞ß‡∞ø ‡∞µ‡±Ä‡∞∞‡±Å‡∞°‡±Å ‡∞∂‡±Ç‡∞∞‡±Å‡∞°‡±Å ‡∞µ‡∞ø‡∞ú‡∞Ø ‡∞§‡∞ø‡∞≤‡∞ï‡∞Ç {{ p1.label }}</div>
              <div class="muted small">Total {{ p1.total }}</div>
            </div>
            <div class="podium-block third" *ngIf="podiumDisplay().top3[2] as p3">
              <div class="trophy">ü•â</div>
              <div class="rank-num">3</div>
              <div class="podium-name">{{ p3.label }}</div>
              <div class="muted small">Total {{ p3.total }}</div>
            </div>
          </div>
        </div>
        <div class="rest" *ngIf="podiumDisplay().rest.length">
          <p class="label">Everyone else</p>
          <div class="rest-row" *ngFor="let row of podiumDisplay().rest; let idx = index">
            <span class="emoji">{{ emojiForRank(idx + 3) }}</span>
            <span class="rank-num small" *ngIf="showRanks()">#{{ idx + 4 }}</span>
            <span class="name">{{ row.label }}</span>
            <span class="total muted">{{ row.total }}</span>
          </div>
        </div>
        <div class="rematch">
          <p class="muted">Want another game? We‚Äôll preload the same players‚Äîadd or delete before starting.</p>
          <button class="primary" type="button" (click)="prepareRematch()">Play another game</button>
        </div>
      </div>
    </div>

    <div class="history-strip">
      <div
        class="history-pill"
        *ngFor="let round of g.rounds; index as i"
        (click)="jumpToRound(i)"
        [class.active]="currentRoundIndex() === i"
      >
        <span>R{{ i + 1 }}</span>
        <span class="muted">{{ roundComplete(i) ? 'Done' : 'Open' }}</span>
      </div>
    </div>
  </section>
</div>
